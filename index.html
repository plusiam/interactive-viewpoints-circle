<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인터랙티브 관점의 원 - Interactive Circle of Viewpoints</title>
    <link href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #06b6d4;
            --accent-color: #f59e0b;
            --bg-gradient-start: #f3e8ff;
            --bg-gradient-end: #dbeafe;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            font-family: 'Pretendard', sans-serif;
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        
        .custom-input {
            background: white;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .custom-input:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1) !important;
            outline: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .viewpoint-item {
            background: #f9fafb;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }
        
        .viewpoint-item:hover {
            transform: translateX(4px);
            border-color: var(--primary-color);
        }
        
        /* 원형 룰렛 스타일 */
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.2);
            transition: transform 5s cubic-bezier(0.33, 1, 0.68, 1);
            border: 6px solid #fff;
        }
        
        .wheel-overlay {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .wheel-section {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
            cursor: pointer;
            pointer-events: all;
        }
        
        .section-text {
            position: absolute;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 18px;
            pointer-events: none;
            max-width: 100px;
            text-align: center;
            word-break: keep-all;
        }
        
        .spin-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: white;
            color: var(--primary-color);
            border: 5px solid #fff;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            z-index: 20;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spin-button:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 30px solid var(--accent-color);
            z-index: 21;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        
        .empty-wheel {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            border: 3px dashed #d1d5db;
            color: #9ca3af;
            font-size: 18px;
            text-align: center;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .wheel-container {
                width: 320px;
                height: 320px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6">
    <div id="captureArea" class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🎯 인터랙티브 관점의 원</h1>
            <p class="text-lg text-gray-600">Interactive Circle of Viewpoints</p>
            <p class="text-sm text-gray-500 mt-1">하버드대학교 프로젝트 제로 - 보이는 사고(Visible Thinking) 루틴</p>
        </header>

        <div class="flex justify-end gap-2 mb-4">
            <button onclick="saveResult()" class="btn-secondary px-4 py-2 rounded-full font-semibold text-sm">🖼️ 결과 저장</button>
            <button onclick="resetAll()" class="btn-secondary px-4 py-2 rounded-full font-semibold text-sm">🔄 새로 시작</button>
        </div>

        <div class="grid lg:grid-cols-5 gap-6">
            <div class="lg:col-span-2 panel p-6 space-y-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-2xl mr-2">📝</span>학습 정보 설정
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">학반</label>
                            <input type="text" id="studentClass" class="custom-input w-full px-4 py-2 rounded-lg" placeholder="예: 6학년 1반">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                            <input type="text" id="studentName" class="custom-input w-full px-4 py-2 rounded-lg" placeholder="홍길동">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">중심 주제</label>
                            <input type="text" id="mainTopic" class="custom-input w-full px-4 py-2 rounded-lg" placeholder="예: 지구 온난화">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-2xl mr-2">🎡</span>관점 추가
                    </h2>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="viewpointInput" class="custom-input flex-1 px-4 py-2 rounded-lg" placeholder="관점 입력 (예: 과학자, 지구)">
                        <button onclick="addViewpoint()" class="btn-primary px-6 py-2 rounded-lg font-medium">추가</button>
                    </div>
                    <div id="viewpointList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                    <p class="text-sm text-gray-500 mt-2">💡 최대 12개까지 추가 가능합니다</p>
                    <button onclick="showExplorationPanel()" class="btn-secondary w-full py-2 rounded-lg font-medium mt-4">
                        ✍️ 탐구 시작하기
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3 panel p-6 flex flex-col items-center justify-center">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <div id="wheel" class="wheel empty-wheel">관점을 추가해주세요</div>
                    <button id="spinButton" class="spin-button" onclick="spinWheel()" style="display: none;">SPIN</button>
                </div>
                <p class="text-center mt-4 text-gray-600 text-sm">
                    🎡 SPIN 버튼을 누르거나 원하는 관점을 직접 클릭하세요!<br>
                    <span class="text-gray-500">또는 왼쪽 '탐구 시작하기' 버튼으로 원하는 관점을 직접 선택할 수 있습니다.</span>
                </p>
            </div>
        </div>

        <div id="explorationPanel" class="mt-6 panel p-6 hidden"></div>
        
        <div id="savedExplorations" class="mt-6 panel p-6 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-3">📊 탐구 기록</h3>
            <div id="explorationList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        let viewpoints = [];
        let currentViewpointIndex = null;
        let isSpinning = false;
        let savedExplorations = [];
        
        const colors = [
            '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899',
            '#6366f1', '#14b8a6', '#84cc16', '#f97316', '#a855f7', '#0ea5e9'
        ];
        
        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('viewpointInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') addViewpoint();
            });
            loadData();
            
            // 자동 저장
            ['studentClass', 'studentName', 'mainTopic'].forEach(id => {
                document.getElementById(id).addEventListener('input', saveData);
            });
        });

        // 관점 추가
        function addViewpoint() {
            const input = document.getElementById('viewpointInput');
            const name = input.value.trim();
            
            if (name && viewpoints.length < 12) {
                if (viewpoints.some(vp => vp.name === name)) {
                    alert('이미 추가된 관점입니다.');
                    return;
                }
                
                viewpoints.push({
                    name,
                    color: colors[viewpoints.length % colors.length]
                });
                
                input.value = '';
                updateUI();
            } else if (viewpoints.length >= 12) {
                alert('최대 12개까지만 추가할 수 있습니다.');
            }
        }

        // 관점 제거
        function removeViewpoint(index) {
            viewpoints.splice(index, 1);
            // 색상 재배정
            viewpoints.forEach((vp, i) => {
                vp.color = colors[i % colors.length];
            });
            updateUI();
        }
        
        // UI 업데이트
        function updateUI() {
            updateViewpointList();
            updateWheel();
            updateExplorationList();
            saveData();
        }

        // 관점 목록 업데이트
        function updateViewpointList() {
            const list = document.getElementById('viewpointList');
            list.innerHTML = viewpoints.map((vp, index) => `
                <div class="viewpoint-item flex justify-between items-center p-2 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full" style="background-color: ${vp.color};"></div>
                        <span class="font-medium text-gray-700">${vp.name}</span>
                    </div>
                    <button onclick="removeViewpoint(${index})" class="text-gray-400 hover:text-red-500 font-bold text-lg px-2">×</button>
                </div>
            `).join('');
        }

        // 원형 룰렛 업데이트
        function updateWheel() {
            const wheel = document.getElementById('wheel');
            const spinButton = document.getElementById('spinButton');
            
            if (viewpoints.length === 0) {
                wheel.className = 'wheel empty-wheel';
                wheel.style.background = '';
                wheel.innerHTML = '관점을 추가해주세요';
                spinButton.style.display = 'none';
                return;
            }
            
            wheel.className = 'wheel';
            spinButton.style.display = 'flex';
            
            // conic-gradient로 원 그리기
            const anglePerSection = 360 / viewpoints.length;
            const gradientStops = [];
            
            viewpoints.forEach((vp, i) => {
                const startAngle = i * anglePerSection;
                const endAngle = (i + 1) * anglePerSection;
                gradientStops.push(`${vp.color} ${startAngle}deg ${endAngle}deg`);
            });
            
            wheel.style.background = `conic-gradient(from -90deg, ${gradientStops.join(', ')})`;
            
            // 텍스트와 클릭 영역 추가
            wheel.innerHTML = '';
            viewpoints.forEach((vp, index) => {
                // 클릭 가능한 영역
                const section = document.createElement('div');
                section.className = 'wheel-section';
                section.style.transform = `rotate(${anglePerSection * index}deg)`;
                section.style.clipPath = `polygon(50% 50%, 50% 0, ${50 + 50 * Math.tan(anglePerSection * Math.PI / 180)}% 0)`;
                section.onclick = () => selectViewpoint(index);
                
                // 텍스트
                const textContainer = document.createElement('div');
                textContainer.style.position = 'absolute';
                textContainer.style.width = '100%';
                textContainer.style.height = '100%';
                
                const text = document.createElement('div');
                text.className = 'section-text';
                const textAngle = anglePerSection * index + anglePerSection / 2 - 90;
                const radius = 120;
                const x = 50 + radius * Math.cos(textAngle * Math.PI / 180) / 2;
                const y = 50 + radius * Math.sin(textAngle * Math.PI / 180) / 2;
                text.style.left = `${x}%`;
                text.style.top = `${y}%`;
                text.style.transform = 'translate(-50%, -50%)';
                text.textContent = vp.name;
                
                textContainer.appendChild(text);
                wheel.appendChild(section);
                wheel.appendChild(textContainer);
            });
        }
        
        // 관점 선택
        function selectViewpoint(index) {
            if (isSpinning) return;
            currentViewpointIndex = index;
            const viewpoint = viewpoints[index];
            showExplorationPanel(viewpoint.name);
        }
        
        // 탐구 패널 표시
        function showExplorationPanel(viewpointName = '') {
            const panel = document.getElementById('explorationPanel');
            panel.classList.remove('hidden');
            
            // 기존 저장된 내용 찾기
            const existing = savedExplorations.find(e => e.viewpoint.name === viewpointName) || {};
            
            panel.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <span class="text-2xl mr-2">🧠</span>관점 탐구하기
                </h2>
                <div class="mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">탐구할 관점을 선택하거나 입력하세요:</label>
                    <div class="flex gap-2">
                        <select id="viewpointSelect" class="custom-input flex-1 px-4 py-2 rounded-lg" onchange="updateSelectedViewpoint()">
                            <option value="">직접 입력...</option>
                            ${viewpoints.map(vp => 
                                `<option value="${vp.name}" ${vp.name === viewpointName ? 'selected' : ''}>${vp.name}</option>`
                            ).join('')}
                        </select>
                        <input type="text" id="customViewpoint" class="custom-input flex-1 px-4 py-2 rounded-lg" 
                               placeholder="새로운 관점 입력" value="${viewpointName}" onkeyup="updateViewpointDisplay()">
                    </div>
                </div>
                
                <div id="explorationContent" class="space-y-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-600 mb-2">
                            <span id="currentViewpointDisplay" class="text-purple-700">${viewpointName || '관점을 선택하세요'}</span>의 입장에서
                        </h3>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">1️⃣ 나는 ~라고 생각한다.</label>
                        <textarea id="thinkText" rows="4" class="custom-input w-full p-3 rounded-lg resize-none" 
                                  placeholder="이 관점에서 주제에 대해 어떻게 생각하는지 작성하세요...">${existing.think || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">2️⃣ 왜냐하면 ~이기 때문이다.</label>
                        <textarea id="becauseText" rows="4" class="custom-input w-full p-3 rounded-lg resize-none" 
                                  placeholder="그렇게 생각하는 이유를 작성하세요...">${existing.because || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">3️⃣ 나는 ~이 궁금하다.</label>
                        <textarea id="wonderText" rows="3" class="custom-input w-full p-3 rounded-lg resize-none" 
                                  placeholder="이 관점에서 궁금한 점이나 질문을 작성하세요...">${existing.wonder || ''}</textarea>
                    </div>
                </div>
                <button onclick="saveExploration()" class="btn-primary w-full py-3 rounded-lg font-medium mt-6">💾 탐구 내용 저장</button>
            `;
            
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateViewpointDisplay();
        }
        
        // 선택된 관점 업데이트
        function updateSelectedViewpoint() {
            const select = document.getElementById('viewpointSelect');
            const customInput = document.getElementById('customViewpoint');
            if (select.value === '') {
                customInput.value = '';
                customInput.focus();
            } else {
                customInput.value = select.value;
            }
            updateViewpointDisplay();
        }
        
        // 관점 표시 업데이트
        function updateViewpointDisplay() {
            const customInput = document.getElementById('customViewpoint');
            const display = document.getElementById('currentViewpointDisplay');
            const currentViewpoint = customInput.value.trim();
            display.textContent = currentViewpoint || '관점을 선택하세요';
        }

        // 룰렛 회전
        function spinWheel() {
            if (isSpinning || viewpoints.length < 1) return;
            isSpinning = true;
            
            const wheel = document.getElementById('wheel');
            const anglePerSection = 360 / viewpoints.length;
            
            // 현재 회전 각도 가져오기
            const currentRotation = getCurrentRotation(wheel);
            
            // 무작위 선택
            const randomIndex = Math.floor(Math.random() * viewpoints.length);
            const targetAngle = anglePerSection * randomIndex + anglePerSection / 2;
            
            // 여러 바퀴 회전 추가
            const extraRotations = 5 + Math.floor(Math.random() * 3);
            const finalRotation = currentRotation + extraRotations * 360 + (360 - targetAngle);
            
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            
            setTimeout(() => {
                isSpinning = false;
                selectViewpoint(randomIndex);
            }, 5000);
        }
        
        // 현재 회전 각도 가져오기
        function getCurrentRotation(element) {
            const transform = window.getComputedStyle(element).transform;
            if (transform === 'none') return 0;
            
            const values = transform.match(/matrix\((.+)\)/)[1].split(', ');
            const a = values[0];
            const b = values[1];
            let angle = Math.atan2(b, a) * (180 / Math.PI);
            
            return angle < 0 ? angle + 360 : angle;
        }

        // 탐구 내용 저장
        function saveExploration() {
            const customViewpoint = document.getElementById('customViewpoint').value.trim();
            
            if (!customViewpoint) {
                alert('탐구할 관점을 선택하거나 입력해주세요.');
                return;
            }
            
            const think = document.getElementById('thinkText').value.trim();
            const because = document.getElementById('becauseText').value.trim();
            const wonder = document.getElementById('wonderText').value.trim();
            
            if (!think && !because && !wonder) {
                alert('최소 하나 이상의 탐구 내용을 입력해주세요.');
                return;
            }
            
            // 선택된 관점의 색상 찾기
            const existingViewpoint = viewpoints.find(vp => vp.name === customViewpoint);
            const viewpointColor = existingViewpoint ? existingViewpoint.color : '#9ca3af';
            
            const exploration = {
                viewpoint: {
                    name: customViewpoint,
                    color: viewpointColor
                },
                think,
                because,
                wonder,
                timestamp: new Date().toLocaleString('ko-KR')
            };
            
            // 같은 관점의 기존 탐구 업데이트 또는 추가
            const existingIndex = savedExplorations.findIndex(exp => 
                exp.viewpoint.name === exploration.viewpoint.name
            );
            
            if (existingIndex !== -1) {
                savedExplorations[existingIndex] = exploration;
            } else {
                savedExplorations.push(exploration);
            }
            
            updateExplorationList();
            saveData();
            
            // 패널 숨기기
            document.getElementById('explorationPanel').classList.add('hidden');
            alert('탐구 내용이 저장되었습니다!');
        }

        // 탐구 기록 업데이트
        function updateExplorationList() {
            const container = document.getElementById('savedExplorations');
            const list = document.getElementById('explorationList');
            
            if (savedExplorations.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            list.innerHTML = savedExplorations.map((exp, index) => `
                <div class="p-4 rounded-lg border bg-white" style="border-left: 5px solid ${exp.viewpoint.color};">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-lg" style="color: ${exp.viewpoint.color};">${exp.viewpoint.name}의 관점</h4>
                        <button onclick="removeExploration(${index})" class="text-gray-400 hover:text-red-500 text-lg font-bold">×</button>
                    </div>
                    ${exp.think ? `<p class="text-sm text-gray-700 mb-2"><strong class="text-purple-600">생각:</strong> ${exp.think}</p>` : ''}
                    ${exp.because ? `<p class="text-sm text-gray-700 mb-2"><strong class="text-orange-600">이유:</strong> ${exp.because}</p>` : ''}
                    ${exp.wonder ? `<p class="text-sm text-gray-700"><strong class="text-cyan-600">궁금한 점:</strong> ${exp.wonder}</p>` : ''}
                    <p class="text-xs text-gray-500 mt-2">${exp.timestamp}</p>
                </div>
            `).join('');
        }
        
        // 탐구 기록 삭제
        function removeExploration(index) {
            savedExplorations.splice(index, 1);
            updateUI();
        }
        
        // 결과 저장
        async function saveResult() {
            const studentClass = document.getElementById('studentClass').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const mainTopic = document.getElementById('mainTopic').value.trim();
            
            if (!studentClass || !studentName || !mainTopic) {
                alert('학습 정보를 모두 입력해주세요.');
                return;
            }
            
            if (viewpoints.length === 0) {
                alert('관점을 추가해주세요.');
                return;
            }
            
            // 버튼 숨기기
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.style.display = 'none');
            
            try {
                const canvas = await html2canvas(document.getElementById('captureArea'), {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                    logging: false
                });
                
                const link = document.createElement('a');
                const date = new Date().toLocaleDateString('ko-KR').replace(/\./g, '');
                link.download = `관점의원_${studentClass}_${studentName}_${date}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } finally {
                // 버튼 다시 표시
                buttons.forEach(btn => btn.style.display = '');
            }
        }

        // 전체 초기화
        function resetAll() {
            if (confirm('모든 내용을 초기화하시겠습니까?\n저장되지 않은 내용은 사라집니다.')) {
                // 데이터 초기화
                viewpoints = [];
                savedExplorations = [];
                currentViewpointIndex = null;
                
                // 입력 필드 초기화
                ['studentClass', 'studentName', 'mainTopic', 'viewpointInput'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                
                // UI 초기화
                document.getElementById('explorationPanel').classList.add('hidden');
                updateUI();
                
                // 로컬 스토리지 초기화
                localStorage.removeItem('circleOfViewpoints');
            }
        }
        
        // 데이터 저장
        function saveData() {
            const data = {
                studentClass: document.getElementById('studentClass').value,
                studentName: document.getElementById('studentName').value,
                mainTopic: document.getElementById('mainTopic').value,
                viewpoints,
                savedExplorations
            };
            localStorage.setItem('circleOfViewpoints', JSON.stringify(data));
        }

        // 데이터 불러오기
        function loadData() {
            const saved = localStorage.getItem('circleOfViewpoints');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('studentClass').value = data.studentClass || '';
                    document.getElementById('studentName').value = data.studentName || '';
                    document.getElementById('mainTopic').value = data.mainTopic || '';
                    viewpoints = data.viewpoints || [];
                    savedExplorations = data.savedExplorations || [];
                    updateUI();
                } catch (e) {
                    console.error('데이터 로드 실패:', e);
                }
            }
        }
    </script>
</body>
</html>